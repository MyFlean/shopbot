version: 1.0
runtime: docker
build:
  commands:
    build:
      - echo "Building Shopping Bot application..."
      - pip3 install --no-cache-dir -r requirements.txt
      - echo "Build completed successfully"
run:
  runtime-version: 3.11
  command: gunicorn --bind 0.0.0.0:8000 --workers 4 --timeout 120 --keep-alive 2 --max-requests 1000 --max-requests-jitter 100 run:app
  network:
    port: 8000
    env: PORT
  env:
    # Application Configuration
    - name: PORT
      value: "8000"
    - name: HOST
      value: "0.0.0.0"
    - name: APP_ENV
      value: "production"
    - name: FLASK_ENV
      value: "production"
    - name: BOT_LOG_LEVEL
      value: "STANDARD"
    
    # Secrets from AWS Secrets Manager
    - name: ANTHROPIC_API_KEY
      value: "arn:aws:secretsmanager:ap-south-1:637607366584:secret:shopping-bot/anthropic-api-key"
    - name: REDIS_HOST
      value: "arn:aws:secretsmanager:ap-south-1:637607366584:secret:shopping-bot/redis-host"
    - name: REDIS_PORT
      value: "arn:aws:secretsmanager:ap-south-1:637607366584:secret:shopping-bot/redis-port"
    - name: ES_API_KEY
      value: "arn:aws:secretsmanager:ap-south-1:637607366584:secret:shopping-bot/es-api-key"
    - name: ES_URL
      value: "arn:aws:secretsmanager:ap-south-1:637607366584:secret:shopping-bot/es-url"
    - name: SECRET_KEY
      value: "arn:aws:secretsmanager:ap-south-1:637607366584:secret:shopping-bot/secret-key"
    
    # Non-sensitive Configuration
    - name: REDIS_TTL_SECONDS
      value: "900"
    - name: LLM_MODEL
      value: "claude-3-5-sonnet-20241022"
    - name: LLM_TEMPERATURE
      value: "0.1"
    - name: LLM_MAX_TOKENS
      value: "1000"
    - name: ELASTIC_INDEX
      value: "flean-v4"
    - name: ELASTIC_TIMEOUT_SECONDS
      value: "10"
    - name: ELASTIC_MAX_RESULTS
      value: "50"
    - name: HISTORY_MAX_SNAPSHOTS
      value: "5"
    
    # Feature Flags
    - name: ENABLE_ASYNC
      value: "false"
    - name: USE_COMBINED_CLASSIFY_ASSESS
      value: "false"
    - name: USE_CONVERSATION_AWARE_CLASSIFIER
      value: "false"
    - name: USE_TWO_CALL_ES_PIPELINE
      value: "false"
    - name: ASK_ONLY_MODE
      value: "false"
    - name: USE_ASSESSMENT_FOR_ASK_ONLY
      value: "false"